{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Transform": "AWS::Serverless-2016-10-31",
  "Description": "CloudFormation template for deploying and managing resources for OpenWeatherMap API integration.",
  "Parameters": {
    "WeatherSourceName": {
      "Description": "API Name",
      "Type": "String"
    },
    "ApplicationName": {
      "Description": "Application Name",
      "Type": "String"
    },
    "Env": {
      "Description": "Environment",
      "Type": "String"
    },
    "OWMApiKey": {
      "Type": "String",
      "NoEcho": "true"
    },
    "OWMGeocodeBaseUrl": {
      "Type": "String",
      "NoEcho": "true"
    },
    "OWMCurrentWeatherBaseUrl": {
      "Type": "String",
      "NoEcho": "true"
    },
    "TelegramBotToken": {
      "Type": "String",
      "NoEcho": "true"
    },
    "TelegramChatId": {
      "Type": "String",
      "NoEcho": "true"
    },
    "MongodbConnectionString": {
      "Type": "String",
      "NoEcho": "true"
    },
    "MongodbDatabase": {
      "Type": "String",
      "NoEcho": "true"
    },
    "BulletinEmailAddress": {
      "Type": "String",
      "NoEcho": "true"
    },
    "BulletEmailAddressAppPassword": {
      "Type": "String",
      "NoEcho": "true"
    },
    "CommonLayerArn": {
      "Type": "String"
    },
    "CommonLambdaRoleArn": {
      "Type": "String"
    }
  },
  "Resources": {
    "LambdaLibsLayer": {
      "Type": "AWS::Serverless::LayerVersion",
      "Properties": {
        "CompatibleRuntimes": ["python3.12", "python3.11"],
        "ContentUri": "layers/libs",
        "Description": "Libraries for OpenWeatherMap Bulletin Lambda",
        "LayerName": {
          "Fn::Sub": "${ApplicationName}-${WeatherSourceName}-lambda-lib-${Env}"
        },
        "LicenseInfo": "MIT"
      }
    },
    "LambdaUtilsLayer": {
      "Type": "AWS::Serverless::LayerVersion",
      "Properties": {
        "CompatibleRuntimes": ["python3.12", "python3.11"],
        "ContentUri": "layers/helper_functions",
        "Description": "Helper Modules for OpenWeatherMap Bulletin Lambda",
        "LayerName": {
          "Fn::Sub": "${ApplicationName}-${WeatherSourceName}-lambda-modules-${Env}"
        },
        "LicenseInfo": "MIT"
      }
    },
    "LambdaFunction": {
      "Type": "AWS::Serverless::Function",
      "Properties": {
        "FunctionName": {
          "Fn::Sub": "${ApplicationName}-${WeatherSourceName}-${Env}"
        },
        "Description": "Lambda Function to Pull Weather Information from OpenWeatherMap API",
        "Runtime": "python3.12",
        "CodeUri": "lambda",
        "Handler": "LambdaFunction.LambdaHandler",
        "MemorySize": 128,
        "Timeout": 300,
        "Role": {
          "Ref": "CommonLambdaRoleArn"
        },
        "Environment": {
          "Variables": {
            "WeatherSourceName": {
              "Ref": "WeatherSourceName"
            },
            "ApplicationName": {
              "Ref": "ApplicationName"
            },
            "Env": {
              "Ref": "Env"
            },
            "TelegramBotToken": {
              "Ref": "TelegramBotToken"
            },
            "TelegramChatId": {
              "Ref": "TelegramChatId"
            },
            "MongodbConnectionString": {
              "Ref": "MongodbConnectionString"
            },
            "MongodbDatabase": {
              "Ref": "MongodbDatabase"
            },
            "BulletinEmailAddress": {
              "Ref": "BulletinEmailAddress"
            },
            "BulletEmailAddressAppPassword": {
              "Ref": "BulletEmailAddressAppPassword"
            },
            "OWMApiKey": {
              "Ref": "OWMApiKey"
            },
            "OWMGeocodeBaseUrl": {
              "Ref": "OWMGeocodeBaseUrl"
            },
            "OWMCurrentWeatherBaseUrl": {
              "Ref": "OWMCurrentWeatherBaseUrl"
            }
          }
        },
        "Layers": [
          {
            "Fn::GetAtt": ["LambdaLibsLayer", "LayerVersionArn"]
          },
          {
            "Fn::GetAtt": ["LambdaUtilsLayer", "LayerVersionArn"]
          },
          {
            "Fn::Sub": "${CommonLayerArn}"
          }
        ]
      }
    },
    "ScheduledRule": {
      "Type": "AWS::Events::Rule",
      "Properties": {
        "Name": {
          "Fn::Sub": "${ApplicationName}-${WeatherSourceName}-eventrule-${Env}"
        },
        "Description": "Triggers the event every day at 6 AM IST.",
        "ScheduleExpression": "cron(30 0 * * ? *)",
        "State": "ENABLED",
        "Targets": [
          {
            "Arn": {
              "Fn::GetAtt": ["LambdaFunction", "Arn"]
            },
            "Id": "LambdaFunction"
          }
        ]
      },
      "DependsOn": "LambdaFunction"
    },
    "PermissionForEventsToInvokeLambda": {
      "Type": "AWS::Lambda::Permission",
      "Properties": {
        "FunctionName": {
          "Ref": "LambdaFunction"
        },
        "Action": "lambda:InvokeFunction",
        "Principal": "events.amazonaws.com",
        "SourceArn": {
          "Fn::GetAtt": ["ScheduledRule", "Arn"]
        }
      },
      "DependsOn": "LambdaFunction"
    }
  }
}
