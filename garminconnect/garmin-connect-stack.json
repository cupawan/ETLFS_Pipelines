{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Transform": "AWS::Serverless-2016-10-31",
  "Description": "CloudFormation template for deploying and managing resources for the Garmin API integration.",
  "Parameters": {
    "SourceName": {
      "Description": "API Name",
      "Type": "String"
    },
    "ApplicationName": {
      "Description": "Application Name",
      "Type": "String"
    },
    "Env": {
      "Description": "Environment",
      "Type": "String"
    },
    "TelegramBotToken": {
      "Type": "String",
      "NoEcho": "true"
    },
    "TelegramChatId": {
      "Type": "String",
      "NoEcho": "true"
    },
    "MyGarminPassword": {
      "Type": "String",
      "NoEcho": "true"
    },
    "MyEmailAddress": {
      "Type": "String",
      "NoEcho": "true"
    },
    "MongodbConnectionString": {
      "Type": "String",
      "NoEcho": "true"
    },
    "MongodbDatabase": {
      "Type": "String",
      "NoEcho": "true"
    },
    "BulletinEmailAddress": {
      "Type": "String",
      "NoEcho": "true"
    },
    "BulletEmailAddressAppPassword": {
      "Type": "String",
      "NoEcho": "true"
    },
    "RecEmail": {
      "Type": "String",
      "NoEcho": "true"
    },
    "GoogleApiKey": {
      "Type": "String",
      "NoEcho": "true"
    },
    "GoogleMapsApiPath": {
      "Type": "String",
      "NoEcho": "true"
    },
    "CommonLayerArn": {
      "Type": "String"
    },
    "CommonLambdaRoleArn": {
      "Type": "String"
    },
    "GarminProfileImageValue": {
      "Type": "String",
      "NoEcho": "true"
    },
    "GarminRunSchedule": {
      "Type": "String"
    }
  },
  "Resources": {
    "LambdaLibsLayer": {
      "Type": "AWS::Serverless::LayerVersion",
      "Properties": {
        "CompatibleRuntimes": ["python3.12", "python3.11"],
        "ContentUri": "layers/libs",
        "Description": "Libraries for Garmin Statistics Lambda",
        "LayerName": {
          "Fn::Sub": "${ApplicationName}-${SourceName}-lambda-lib-${Env}"
        },
        "LicenseInfo": "MIT"
      }
    },
    "LambdaUtilsLayer": {
      "Type": "AWS::Serverless::LayerVersion",
      "Properties": {
        "CompatibleRuntimes": ["python3.12", "python3.11"],
        "ContentUri": "layers/helper_functions",
        "Description": "Helper Modules for Garmin Statistics Lambda",
        "LayerName": {
          "Fn::Sub": "${ApplicationName}-${SourceName}-lambda-modules-${Env}"
        },
        "LicenseInfo": "MIT"
      }
    },
    "LambdaFunction": {
      "Type": "AWS::Serverless::Function",
      "Properties": {
        "FunctionName": {
          "Fn::Sub": "${ApplicationName}-${SourceName}-${Env}"
        },
        "Description": "Lambda Function to Pull Statistics from Garmin API",
        "Runtime": "python3.12",
        "CodeUri": "lambda",
        "Handler": "LambdaFunction.LambdaHandler",
        "MemorySize": 128,
        "Timeout": 300,
        "Role": {
          "Ref": "CommonLambdaRoleArn"
        },
        "Environment": {
          "Variables": {
            "Env": {
              "Ref": "Env"
            },
            "TelegramBotToken": {
              "Ref": "TelegramBotToken"
            },
            "TelegramChatId": {
              "Ref": "TelegramChatId"
            },
            "MyGarminPassword": {
              "Ref": "MyGarminPassword"
            },
            "MyEmailAddress": {
              "Ref": "MyEmailAddress"
            },
            "SourceName": {
              "Ref": "SourceName"
            },
            "MongodbConnectionString": {
              "Ref": "MongodbConnectionString"
            },
            "MongodbDatabase": {
              "Ref": "MongodbDatabase"
            },
            "BulletinEmailAddress": {
              "Ref": "BulletinEmailAddress"
            },
            "BulletEmailAddressAppPassword": {
              "Ref": "BulletEmailAddressAppPassword"
            },
            "RecEmail": {
              "Ref": "RecEmail"
            },
            "ApplicationName": {
              "Ref": "ApplicationName"
            },
            "GoogleApiKey": {
              "Ref": "GoogleApiKey"
            },
            "GoogleMapsApiPath": {
              "Ref": "GoogleMapsApiPath"
            },
            "GarminProfileImage": {
              "Ref": "GarminProfileImageValue"
            },
            "RunHour": {
              "Ref": "GarminRunSchedule"
            }
          }
        },
        "Layers": [
          {
            "Fn::GetAtt": ["LambdaLibsLayer", "LayerVersionArn"]
          },
          {
            "Fn::GetAtt": ["LambdaUtilsLayer", "LayerVersionArn"]
          },
          {
            "Fn::Sub": "${CommonLayerArn}"
          }
        ]
      }
    },
    "ScheduledRuleForSleep": {
      "Type": "AWS::Events::Rule",
      "Properties": {
        "Name": {
          "Fn::Sub": "${ApplicationName}-${SourceName}-sleep-eventrules-${Env}"
        },
        "Description": "Triggers the event every day at 7 AM IST.",
        "ScheduleExpression": "cron(30 1 * * ? *)",
        "State": "DISABLED",
        "Targets": [
          {
            "Arn": {
              "Fn::GetAtt": ["LambdaFunction", "Arn"]
            },
            "Id": "LambdaFunction"
          }
        ]
      },
      "DependsOn": "LambdaFunction"
    },
    "ScheduledRuleForRun": {
      "Type": "AWS::Events::Rule",
      "Properties": {
        "Name": {
          "Fn::Sub": "${ApplicationName}-${SourceName}-run-eventrules-${Env}"
        },
        "Description": "Triggers the event every day at 8 AM IST.",
        "ScheduleExpression": "cron(30 2 * * ? *)",
        "State": "DISABLED",
        "Targets": [
          {
            "Arn": {
              "Fn::GetAtt": ["LambdaFunction", "Arn"]
            },
            "Id": "LambdaFunction"
          }
        ]
      },
      "DependsOn": "LambdaFunction"
    },
    "InvokePermissionForSleepEventsRule": {
      "Type": "AWS::Lambda::Permission",
      "Properties": {
        "FunctionName": {
          "Ref": "LambdaFunction"
        },
        "Action": "lambda:InvokeFunction",
        "Principal": "events.amazonaws.com",
        "SourceArn": {
          "Fn::GetAtt": ["ScheduledRuleForSleep", "Arn"]
        }
      },
      "DependsOn": "LambdaFunction"
    },
    "InvokePermissionForRunEventsRule": {
      "Type": "AWS::Lambda::Permission",
      "Properties": {
        "FunctionName": {
          "Ref": "LambdaFunction"
        },
        "Action": "lambda:InvokeFunction",
        "Principal": "events.amazonaws.com",
        "SourceArn": {
          "Fn::GetAtt": ["ScheduledRuleForRun", "Arn"]
        }
      },
      "DependsOn": "LambdaFunction"
    }
  }
}
